@using Era_sphere.Areas.AreaContable.Models
@using Telerik.Web.Mvc.UI
@model EntregaOCView
@{
    ProveedorView provee = ViewBag.proveedor;
    EntregaOCView eoc = ViewBag.entregaoc;
    OrdenCompraView oc = ViewBag.ordendecompra;
    var data_eoc = new { id_eoc = eoc.entregaID };
    var data = new { id_oc=oc.ordenID};
}
<div id="popupEOC">
    <ul>
        <li>
            <label>Numero de Entrega de Orden de Compra: @data_eoc</label>
            
        </li>
        <li>
            <label>Orden de Compra: @oc.ordenID</label>
        </li>
        <li>
            <label>Proveedor:</label>
            <span>@provee.razon_social</span>
        </li>
    </ul>
    <form id="formAtencionProducto" class="form" action="#">
        <label>Seleccionar producto: (Nombre del producto / cantidad atendida / cantidad pedida)</label>
        @(Html.Telerik()
              .ComboBox()
              .Name("productoatendido_input")
              .DataBinding(bind=>bind.Ajax()
                  .Select("LineaOC", "EntregaOC", @data))
              .Placeholder("Seleccione un producto a atender")
              .HtmlAttributes(new {style= "width:200"})
         )
        <label>Cantidad atendida:</label>
        @(Html.Telerik()
              .IntegerTextBox()
              .Value(1)
              .MinValue(1)
              .Spinners(true)
              .Name("cantidadatendida_input")
         )
        <span style="margin: 2px">
        <input type="submit" class="t-button t-state-default submit" id="agregar_producto"
        value="Agregar Producto Atendido" style="margin: 10px;" />        
    </span>
    </form>
    <script type="text/javascript">
        $("#formProducto").submit(function (e) {
            e.preventDefault();
            var id_productof = $("#productoatendido_input").val();
            var cantidadf = $("#cantidadatendida_input").val();
            if (id_productof == "" || cantidadf == "") {
                alert("Ingrese el producto atendido y su cantidad");
                return false;
            }
            $.ajax({
                type: 'POST',
                url: '@Url.Action("InsertEOCLinea", "EntregaOC", @data_eoc)',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({ id_productoa: id_productof, cantidada: cantidadf }),
                success: function (result) {
                    if (result.msg == "error") { alert("Ingrese los datos correctos"); }
                    else
                        $("#EOCGrid").data('tGrid').ajaxRequest();
                }
            });
        })        
    </script>
    @(Html.Telerik().Grid<EOCLineaView>()
        .Name("OCGrid")
        .DataKeys(d => d.Add(p => p.ID))
        .Columns(columns =>
        {
            columns.Bound(e => e.productoID).Width(100).ReadOnly(true);
            columns.Bound(e => e.producto).Width(200).ReadOnly(true);
            columns.Bound(e => e.cantidad).Width(50);
            columns.Bound(o => o.precio_unitario).Width(50).ReadOnly(true);
            columns.Bound(o => o.precio_total).Format("{0:c}").Width(120).ReadOnly(true)
                .Aggregate(aggregates => aggregates.Sum())
                .ClientFooterTemplate("Total: <#= $.telerik.formatString('{0:c}', Sum) #>");
            columns.Command(command =>
            {
                command.Delete().ButtonType(GridButtonType.Image);
                command.Edit().ButtonType(GridButtonType.Image);
            });
        })
        .ClientEvents(e => e.OnComplete("onCompleteOCL"))
        .DataBinding(dataBinding => dataBinding
            .Ajax()
            .Select("SelectEOCompraLinea", "OrdenCompra", new { id_oc = @oc.ordenID })
            .Delete("DeleteEOCL", "OrdenCompra", new { id_oc = @oc.ordenID })
            .Update("UpdateEOCL", "OrdenCompra")
        )
    )





</div>